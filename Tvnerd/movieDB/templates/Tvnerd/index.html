<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVNerd Home Page</title>
    <link rel="stylesheet" href="{% static 'Tvnerd/css/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        function toggleMenu() {
            var menu = document.getElementById('profile-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function searchMovies() {
            let query = document.getElementById('search-input').value;
            fetch(`/api/search?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    let dropdown = document.getElementById('search-results');
                    dropdown.innerHTML = '';
                    data.forEach(movie => {
                        let option = document.createElement('div');
                        option.classList.add('search-item');
                        option.setAttribute('data-id', movie.id);
                        option.onclick = function() {
                            window.location.href = `/movies?id=${movie.id}`;
                        };
                        let img = document.createElement('img');
                        img.src = `https://image.tmdb.org/t/p/w500/${movie.poster_path}`;
                        img.alt = movie.title;
                        img.classList.add('thumbnail');
                        let text = document.createElement('span');
                        text.textContent = movie.title;
                        option.appendChild(img);
                        option.appendChild(text);
                        dropdown.appendChild(option);
                    });
                });
        }
    </script>
    <style>
        .profile-container {
            position: relative;
            display: inline-block;
        }

        .profile-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            color: #000;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0,Â 0.1);
        }

        #search-results {
            border: 1px solid #ccc;
            display: block;
            width: 297px;
            position: absolute;
            background: white;
            color: #000 !important;
            max-height: 215px;
            overflow-y: auto;
            top: 79px;
        }

        #search-results div {
            padding: 10px;
            cursor: pointer;
            color: #000 !important;
        }

        #search-results div:hover {
            background: #f0f0f0;
            color: #000 !important;
        }
        #search-results .search-item {
            display: flex;
            align-items: center;
        }
        .thumbnail {
            width: 40px;
            height: 60px;
            margin-right: 10px;
            object-fit: cover;
        }
        
    </style>
</head>

<body>

    <header>
        <div class="header-container">
            <div class="logo">
                <img src="{% static 'Tvnerd/images/l1.png' %}" alt="Logo Image">
            </div>
            <nav class="menu">
                <ul>
                    <li><a href="/dashboard">Home</a></li>
                    <li><a href="/tvshows">TV Shows</a></li>
                    <li><a href="/celeb">Celebrities</a></li>
                    <li><a href="/awards">Awards</a></li>
                    <li><a href="#">More</a>
                        <ul class="dropdown">
                            <li><a href="/video">Video</a></li>
                            <li><a href="/nominees">Nominees</a></li>
                            <li><a href="/news">News</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="search-bar">
                <input type="text" id="search-input" onkeyup="searchMovies()" placeholder="Search for movies...">
                <div id="search-results"></div>
            </div>
    
            <div class="user-options">
                {% if request.session.username %}
                <div class="profile-container">
                    <button onclick="toggleMenu()">
                        <p>Hello, {{ request.session.username }}</p>
                    </button>
                    <div id="profile-menu" class="profile-menu">
                        <p>Hello, {{ request.session.username }}</p>
                        <a href="{% url 'watchlist' %}">Watchlist</a>
                        <a href="{% url 'logout' %}">Logout</a>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'login' %}">Sign In</a>
                {% endif %}
            </div>
        </div>
    </header>

    {% if request.session.username %}
    <h2>Notifications</h2>
    <div id="notifications" class="notification-list"></div>
    {% endif %}

    <script>
        // Fetch notifications from Flask API
        {% if request.session.username %}
        fetch('http://localhost:5000/api/notifications?user_id={{ request.session.user_id }}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('notifications');
                if (data.length === 0) {
                    container.innerHTML = '<p>No new notifications.</p>';
                    return;
                }
                data.forEach(notification => {
                    const notificationDiv = document.createElement('div');
                    notificationDiv.className = 'notification';
                    notificationDiv.innerHTML = `
                        <p>${notification.message} (${new Date(notification.created_at).toLocaleString()})</p>
                        <button onclick="markAsRead(${notification.id})">Mark as Read</button>
                    `;
                    container.appendChild(notificationDiv);
                });
            })
            .catch(error => console.error('Error fetching notifications:', error));

        function markAsRead(notificationId) {
            fetch(`http://localhost:5000/api/notifications/${notificationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_read: true })
            })
            .then(response => response.json())
            .then(() => {
                document.querySelector(`.notification button[onclick="markAsRead(${notificationId})"]`).parentElement.remove();
            })
            .catch(error => console.error('Error marking notification as read:', error));
        }
        {% endif %}
    </script>
    
    <h1>Latest Movies</h1>
    <div class="scroll-container1">
        <button class="scroll-btn left"><i class="fas fa-chevron-left"></i></button>
        <div class="scroll-content">
            {% for movie in latest_movies %}
            <section class="movie">
                <figure>
                    <a href="/movies?id={{ movie.id }}">
                        <img src="https://image.tmdb.org/t/p/w1280{{ movie.backdrop_path }}" alt="{{ movie.title }}">
                        <figcaption class="movie-title">
                            <strong>{{ forloop.counter }}. {{ movie.title }}</strong>
                            <p>Release Date: 
                            {{ movie.release_date|default:"N/A" }}</p>
                            Rating: {{ movie.vote_average|default:"N/A" }}
                        </figcaption>
                    </a>
                </figure>
            </section>
            {% empty %}
            <p>No latest movies found.</p>
            {% endfor %}
        </div>
        <button class="scroll-btn right"><i class="fas fa-chevron-right"></i></button>
    </div>
    


        <h1>Top 10 on IMDB this week</h1>
    <div class="scroll-container">
        <button class="scroll-btn left"><i class="fas fa-chevron-left"></i></button>
        <div class="scroll-content">
            {% for movie in top_movies %}
            <section>
                <figure>
                    <a href="/movies?id={{ movie.id }}">
                        <img src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
                        <figcaption>
                            {{ forloop.counter }}. {{ movie.title }}<br>
                            Watch Options<br>
                            Trailer
                        </figcaption>
                    </a>
                </figure>
            </section>
            {% empty %}
            <p>No top movies found.</p>
            {% endfor %}
        </div>
        <button class="scroll-btn right"><i class="fas fa-chevron-right"></i></button>
    </div>

  
    <script src="{% static 'Tvnerd/js/script.js' %}"></script>

    
    
    
    
    <script src="{% static 'Tvnerd/js/script.js' %}"></script>

    {% if request.session.username %}
    <script>
        // Store session flag in sessionStorage
        sessionStorage.setItem("active_session", "true");
    
        // Whether session is permanent or not (set by backend)
        var isPermanent = "{{ is_permanent|yesno:'true,false' }}" === "true";

    
        // Detect tab close and trigger logout ONLY IF session is NOT permanent
        window.addEventListener("beforeunload", function () {
            if (!isPermanent && sessionStorage.getItem("active_session") === "true") {
                navigator.sendBeacon("{% url 'logout' %}", ""); // Fire logout request
                sessionStorage.removeItem("active_session");
            }
        });
    </script>
    {% endif %}
    

    <script src="search.js"></script>
</body> 

</html> 

